name: "SAST"

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  schedule:
    - cron: '15 22 * * 2'

jobs:
  sast_analysis:
    name: Run SAST Tools
    runs-on: ubuntu-latest
    permissions:
      security-events: write 
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Bandit
        run: |
          pip install bandit
          bandit -r . -f txt -o bandit_results.txt || true
          
      - name: Run Semgrep
        run: |
          docker run --rm -v "${{ github.workspace }}:/src" returntocorp/semgrep \
          semgrep --config=auto --config=p/python --config=p/flask --config=p/html \
          --text -o semgrep_results.txt || true

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python, javascript # HTML se analiza dentro de estas suites

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: Upload Scan Reports
        uses: actions/upload-artifact@v4
        with:
          name: sast-reports
          path: |
            bandit_results.txt
            semgrep_results.txt
